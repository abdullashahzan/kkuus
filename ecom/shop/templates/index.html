{% extends 'layout.html' %}
{% load static %}

{% block title %}
{% if user.is_authenticated %}
<title>Welcome, {{request.user.first_name}}!</title>
{% else %}
<title>Welcome, user!</title>
{% endif %}
{% endblock %}

{% block body %}
<div id="myModal" class="container-fluid slideInDown">
    <div class="row d-flex justify-content-center align-items-center">
        <div class="col-md-6 d-flex justify-content-center align-items-center my-4">
            <img class="widthlock" src="{% static 'media/search.svg' %}" alt="image">
        </div>
        <div class="col-md-6">
            <article>
                <h1 class="style-text-3">Search for an item</h1>
                <p class="lead style-text text-muted">
                    Type the name or description about the product
                </p>
                <form action="{% url 'shop:search_item' %}" method="post" class="style-text">
                    {% csrf_token %}
                    <input type="text" class="form-control mb-3 shadow" placeholder="Type here.." name="search">
                    <button type="submit" class="btn btn-outline-primary"
                        onclick="this.disabled=true; this.value='Searching...'; this.form.submit();">
                        Search product</button>
                    <button class="btn btn-outline-danger" type="button" onclick="closeModal()">Cancel</button>
                </form>
            </article>
        </div>
    </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="container mb-4">
    <div class="row" data-masonry='{"percentPosition": true }'>
        {% for item in page_obj %}
        <div class="col-sm-2 col-xs-2 col-md-6 col-lg-3 g-3">
            <div class="shadow fadeInUp card hidden my-1 d-flex align-items-center">
                {% if item.num_orders != 0 %}
                <div class="card-header style-text text-primary" style="width: 100%;">Bought by {{item.num_orders}}
                    user(s)</div>
                {% endif %}
                <div id="loader" class="loader"></div>
                <img class="heightlock p-2" src="{% url 'shop:get_image' item.firebase_path %}" class="card-img-top"
                    alt="{{item.product_name}}" id="image">
                <div class="card-body mt-2" style="width: 100%;">
                    <h5 class="card-title text-primary" id="itemModal{{ item.id }}"><a
                            href="{% url 'shop:buy' item.id %}"
                            class="text-primary style-text">{{item.product_name}}</a></h5>
                    <hr>
                    <h5 class="card-title style-text">SAR {{item.product_price}}</h5>
                    <p class="card-text text-muted style-text-2 truncate-3-lines">{{item.product_description}}</p>
                    <p class="text-muted style-text"><i class="bi bi-star-fill lead"></i> {{item.ratings}}/5.0
                        ({{item.num_raters}})</p>
                    {% if user.username != item.username %}
                    {% if item.id in bought_items %}
                    <a href="{% url 'shop:myOrders' %}" class="btn btn-primary my-2">Requested</a>
                    {% elif item.id in completed_items %}
                    <button class="btn btn-disabled my-2 text-primary">Purchased</button>
                    {% else %}
                    <a href="{% url 'shop:buy' item.id %}" class="btn btn-primary my-2">Show item</a>
                    {% endif %}
                    {% if item.id in wishlist %}
                    <button class="btn btn-outline-primary add-to-wishlist" data-item-id="{{ item.id }}">
                        <i class="bi bi-star-fill"></i></button>
                    {% else %}
                    <button class="btn btn-outline-primary add-to-wishlist" data-item-id="{{ item.id }}">
                        <i class="bi bi-star"></i></button>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="card-footer style-text-2 text-light bg-primary d-none d-lg-block" style="width: 100%;">
                    Posted on
                    {{item.timestamp}}</div>
            </div>
        </div>
        {% empty %}
        <div class="row d-none d-lg-flex align-items-center p-4" style="min-height: 80vh;">
            <div class="col-md-7 animate__animated animate__bounceIn">
                <h1 class="style-text-3">No products for sale...</h1>
                <p class="text-muted style-text">Marketplace seems empty today</p>
            </div>
            <div class="col-md-5 d-flex justify-content-center align-items-center">
                <img class="widthlock" src="{% static 'media/undraw_empty_re_opql.svg' %}" alt="empty">
            </div>
        </div>
        <div class="container d-flex d-lg-none justify-content-center align-items-center mt-2"
            style="min-height: 50vh;">
            <div class="col-12 col-md-5">
                <div class="card shadow">
                    <img class="widthlock" src="{% static 'media/undraw_empty_re_opql.svg' %}" alt="empty">
                    <div class="card-body">
                        <article>
                            <h1 class="style-text-3 my-3">No products for sale...</h1>
                            <hr>
                            <p class="text-muted style-text">Marketplace seems empty today</p>
                            <a href="{% url 'shop:new_listing' %}" class="btn btn-outline-primary style-text-2">Sell
                                your product</a>
                        </article>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination links -->
<div class="pagination d-flex justify-content-center align-items-center my-4 style-text">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a class="mx-1 btn btn-primary" title="First page" href="?page=1"><i class="bi bi-chevron-double-left"></i></a>
            <a class="mx-1 btn btn-primary" title="Previous page" href="?page={{ page_obj.previous_page_number }}"><i class="bi bi-chevron-left"></i></a>
        {% endif %}

        <span class="current mx-3">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a class="mx-1 btn btn-primary" title="Next page" href="?page={{ page_obj.next_page_number }}"><i class="bi bi-chevron-right"></i></a>
            <a class="mx-1 btn btn-primary" title="Last page" href="?page={{ page_obj.paginator.num_pages }}"><i class="bi bi-chevron-double-right"></i></a>
        {% endif %}
    </span>
</div>

<script>
    var csrftoken = $("[name=csrfmiddlewaretoken]").val();
    $('.add-to-wishlist').on('click', function () {
        var icon = $(this).find('i');
        var item_id = $(this).data('item-id');
        if (icon.hasClass('bi bi-star')) {
            // Add item to wishlist
            $.ajax({
                url: '/addToWishlist/' + item_id,
                type: 'POST',
                dataType: 'json',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    alert(data.message);
                    icon.removeClass('bi bi-star').addClass('bi bi-star-fill');
                },
                error: function (xhr, errmsg, err) {
                    alert('Failed to add item to your wishlist');
                }
            });
        } else if (icon.hasClass('bi bi-star-fill')) {
            // Remove item from wishlist
            $.ajax({
                url: '/removeFromWishlist/' + item_id,
                type: 'POST',
                dataType: 'json',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    alert(data.message);
                    icon.removeClass('bi bi-star-fill').addClass('bi bi-star');
                },
                error: function (xhr, errmsg, err) {
                    alert('Failed to remove item from your wishlist');
                }
            });
        }
    });
    $('#searchButton').prop('disabled', false);
    $('.home-bar').addClass('this-active');
</script>

{% endblock %}