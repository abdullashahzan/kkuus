{% extends 'ar/layout.html' %}
{% load static %}

{% block title %}
{% if user.is_authenticated %}
<title>Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ {{request.user.first_name}}!</title>
{% else %}
<title>Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ù…Ø³ØªØ®Ø¯Ù…!</title>
{% endif %}
{% endblock %}

{% block body %}
<div id="myModal" class="container-fluid slideInDown">
    <div class="row d-flex justify-content-center align-items-center">
        <div class="col-md-6 d-flex justify-content-center align-items-center my-4">
            <img class="widthlock" src="{% static 'media/search.svg' %}" alt="ØµÙˆØ±Ø©">
        </div>
        <div class="col-md-6">
            <article>
                <h1 class="style-text-3">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ØµØ±</h1>
                <p class="lead style-text text-muted">
                    Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ø£Ùˆ ÙˆØµÙÙ‹Ø§ Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬
                </p>
                <form action="{% url 'shop:search_item' %}" method="post" class="style-text">
                    {% csrf_token %}
                    <input type="text" class="form-control mb-3 shadow" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§.." name="search">
                    <button type="submit" class="btn btn-outline-primary"
                        onclick="this.disabled=true; this.value='Ø¬Ø§Ø± Ø§Ù„Ø¨Ø­Ø«...'; this.form.submit();">
                        Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬</button>
                    <button class="btn btn-outline-danger" type="button" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </form>
            </article>
        </div>
    </div>
</div>
{% if not first_visit and user.is_authenticated %}
<div class="notice">
    <div class="card p-md-3 p-2 mx-4 col-md-6 bg-light shadow animate__animated animate__zoomIn">
        <div class="card-body">
            <h1 class="style-text-3">!Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
            <hr>
            <p class="style-text-2">
                "Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø³Ù„Ø¹Ø© Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„ÙŠÙ‡Ø§ØŸ Ù„Ù…Ø§Ø°Ø§ ØªØ±Ù…ÙŠÙ‡Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨ÙŠØ¹Ù‡Ø§ØŸ ÙŠÙˆÙØ± Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†ØµØ© Ø­ÙŠØ« ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ ÙˆØ¨ÙŠØ¹ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡. <br><br>
                ÙˆØµÙ„ Ø¥Ù„Ù‰ Ø¬Ù…Ù‡ÙˆØ± ÙŠØ¨Ù„Øº Ø¹Ø¯Ø¯Ù‡Ù… Ø§Ù„Ø¢Ù„Ø§Ù Ø¨Ø¨Ø¶Ø¹ Ù†Ù‚Ø±Ø§Øª ÙÙ‚Ø·ØŒ Ù…ØµØ¯Ø± Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ğŸ˜
            </p>
            <div class="style-text mt-4">
                <button class="btn btn-primary" onclick="document.querySelector('.notice').style.display='none';">Ø§Ø¨Ø¯Ø£
                    Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù!</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if notice and user.is_authenticated %}
<div class="devnotice">
    <div class="card p-md-3 p-2 mx-4 col-md-6 bg-light shadow animate__animated animate__zoomIn">
        <div class="card-body">
            <h1 class="style-text-3">{{notice.title}}</h1>
            <hr>
            <p class="style-text-2">
                {{notice.body}}
            </p>
            <div class="style-text mt-4">
                <button class="btn btn-primary"
                    onclick="document.querySelector('.devnotice').style.display='none';">{{notice.button_text}}</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="container mb-4">
    {% if not user.is_authenticated %}
    <div class="row bg-danger my-3 mx-1">
        <a href="{% url 'shop:login_user' %}" class="style-text-2 text-light py-2 text-decoration-none lead">Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù…
            Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ‚Ø¯Ù…Ù‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</a>
    </div>
    {% endif %}
    {% if new_orders %}
    <div class="row bg-danger my-3 mx-1 animate__animated animate__flash">
        <a href="{% url 'shop:my_shop' %}" class="style-text-2 text-light py-2 text-decoration-none lead">Ù„Ø¯ÙŠÙƒ
            {{new_orders}} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</a>
    </div>
    {% endif %}
    <div class="row mx-1 mx-md-0" data-masonry='{"percentPosition": true }'>
        {% for item in page_obj %}
        <div class="col-sm-2 col-xs-2 col-md-6 col-lg-3 g-3">
            <div class="shadow card card-item hidden mb-1 d-flex align-items-center">
                <div class="card-header style-text bg-primary text-light" style="width: 100%;">Ù…ØªØ¬Ø± @{{item.username}}
                </div>
                <img src="{% url 'shop:get_image' item.firebase_path %}" class="heightlock" alt="{{item.product_name}}">
                <div class="card-body mt-2" style="width: 100%;">
                    <h4 class="text-primary" id="itemModal{{ item.id }}"><a href="{% url 'shop:buy' item.id %}"
                            class="text-primary style-text-3"
                            onclick="this.classList.add('disabled');">{{item.product_name}}</a></h4>
                    <hr>
                    <h4 class="style-text-2">Ø±ÙŠØ§Ù„ {{item.product_price}}</h4>
                    <p class="style-text">
                        <i class="bi bi-heart-fill lead text-danger"></i><span class="mx-2">{{item.ratings}}/5.0
                            ({{item.num_raters}})</span>
                        <span class="card-text style-text text-muted truncate-3-lines"><i
                                class="bi bi-bag-fill lead text-primary"></i> <span class="mx-1">ØªÙ… Ø´Ø±Ø§Ø¤Ù‡ Ù…Ù† Ù‚Ø¨Ù„:
                                {{item.num_orders}} Ù…Ø´ØªØ±Ù</span></span>
                    </p>
                    <p>
                        <span class="card-text style-text-2 truncate-3-lines">{{item.product_description}}</span>
                    </p>
                    <div class="style-text-2">
                        {% if user.username != item.username %}
                        {% if item.id in bought_items %}
                        <a href="{% url 'shop:myOrders' %}" class="btn btn-primary my-2"
                            onclick="this.classList.add('disabled');">Ù…Ø·Ù„ÙˆØ¨</a>
                        {% elif item.id in completed_items %}
                        <button class="btn btn-disabled my-2 text-primary">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
                        {% else %}
                        <a href="{% url 'shop:buy' item.id %}" class="btn btn-primary my-2"
                            onclick="this.classList.add('disabled');">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</a>
                        {% endif %}
                        {% if item.id in wishlist %}
                        <button class="btn btn-outline-primary add-to-wishlist" data-item-id="{{ item.id }}">
                            <i class="bi bi-star-fill"></i></button>
                        {% else %}
                        <button class="btn btn-outline-primary add-to-wishlist" data-item-id="{{ item.id }}">
                            <i class="bi bi-star"></i></button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="row d-none d-lg-flex align-items-center p-4" style="min-height: 80vh;">
            <div class="col-md-7 animate__animated animate__bounceIn">
                <h1 class="style-text-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¨ÙŠØ¹...</h1>
                <p class="text-muted style-text">ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ø³ÙˆÙ‚ ÙØ§Ø±Øº Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
            <div class="col-md-5 d-flex justify-content-center align-items-center">
                <img class="widthlock" src="{% static 'media/undraw_empty_re_opql.svg' %}" alt="ÙØ§Ø±Øº">
            </div>
        </div>
        <div class="container d-flex d-lg-none justify-content-center align-items-center mt-2"
            style="min-height: 50vh;">
            <div class="col-12 col-md-5">
                <div class="card shadow animate__animated animate__zoomIn">
                    <img class="widthlock" src="{% static 'media/undraw_empty_re_opql.svg' %}" alt="ÙØ§Ø±Øº">
                    <div class="card-body">
                        <article>
                            <h1 class="style-text-3 my-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¨ÙŠØ¹...</h1>
                            <hr>
                            <p class="text-muted style-text">ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ø³ÙˆÙ‚ ÙØ§Ø±Øº Ø§Ù„ÙŠÙˆÙ…</p>
                            <a href="{% url 'shop:new_listing' %}" class="btn btn-outline-primary style-text-2">Ø¨ÙŠØ¹
                                Ù…Ù†ØªØ¬Ùƒ</a>
                        </article>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination links -->
<div class="pagination d-flex justify-content-center align-items-center my-4 style-text">
    <span class="step-links">
        {% if page_obj.has_previous %}
        <a class="mx-1 btn btn-primary" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" href="?page=1"><i
                class="bi bi-chevron-double-left"></i></a>
        <a class="mx-1 btn btn-primary" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©" href="?page={{ page_obj.previous_page_number }}"><i
                class="bi bi-chevron-left"></i></a>
        {% endif %}

        <span class="current mx-3">
            Ø§Ù„ØµÙØ­Ø© {{ page_obj.number }} Ù…Ù† {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a class="mx-1 btn btn-primary" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©" href="?page={{ page_obj.next_page_number }}"
            onclick="this.classList.add('disabled');"><i class="bi bi-chevron-right"></i></a>
        <a class="mx-1 btn btn-primary" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©" href="?page={{ page_obj.paginator.num_pages }}"
            onclick="this.classList.add('disabled');"><i class="bi bi-chevron-double-right"></i></a>
        {% endif %}
    </span>
</div>

<script>
    localStorage.clear()
    var csrftoken = $("[name=csrfmiddlewaretoken]").val();
    $('.add-to-wishlist').on('click', function () {
        var icon = $(this).find('i');
        var item_id = $(this).data('item-id');
        if (icon.hasClass('bi bi-star')) {
            // Add item to wishlist
            $.ajax({
                url: '/addToWishlist/' + item_id,
                type: 'POST',
                dataType: 'json',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    alert(data.message);
                    icon.removeClass('bi bi-star').addClass('bi bi-star-fill');
                },
                error: function (xhr, errmsg, err) {
                    alert('ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØºØ¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ');
                }
            });
        } else if (icon.hasClass('bi bi-star-fill')) {
            // Remove item from wishlist
            $.ajax({
                url: '/removeFromWishlist/' + item_id,
                type: 'POST',
                dataType: 'json',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    alert(data.message);
                    icon.removeClass('bi bi-star-fill').addClass('bi bi-star');
                },
                error: function (xhr, errmsg, err) {
                    alert('ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØºØ¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ');
                }
            });
        }
    });
    $('#searchButton').prop('disabled', false);
    $('.home-bar').addClass('this-active');

    $(window).on('scroll', function () {
        $('.card-item').each(function () {
            var cardTop = $(this).offset().top;
            var windowHeight = $(window).height();
            var scrollTop = $(window).scrollTop();

            // Check if the bottom of the card is above the viewport and the top of the card is below the viewport
            var isAboveViewport = (cardTop + $(this).outerHeight()) < scrollTop;
            var isBelowViewport = cardTop > (scrollTop + windowHeight);

            // If the card is partially or fully visible in the viewport
            if (!isAboveViewport && !isBelowViewport) {
                $(this).removeClass('hidden');
            } else {
                $(this).addClass('hidden');
            }
        });
    });

    // Initially reveal the first 4 cards
    $(document).ready(function () {
        $('.card-item.hidden:lt(4)').removeClass('hidden');
    });
</script>

{% endblock %}